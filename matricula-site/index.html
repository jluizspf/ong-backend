<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Matrícula - ONG Moradia e Cidadania</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<style>
body { font-family: 'Poppins', sans-serif; margin:0; background:#f9f9f9; color:#333; }
header { text-align:center; padding:40px 20px; background: rgba(44,62,80,0.85); color:#fff; display:flex; flex-direction:column; align-items:center; }
h1 { margin:0; font-size:28px; }
h2 { margin-top:10px; font-weight: normal; font-size:18px; }
.container { max-width:900px; margin:30px auto; padding:20px; }
.card { background: rgba(255,255,255,0.95); padding:25px; margin-bottom:20px; border-radius:16px; box-shadow:0 6px 12px rgba(0,0,0,0.1);}
h3 { display:flex; align-items:center; gap:8px; color:#2c3e50; }
button { background:#6fcf97; color:#fff; border:none; padding:14px 24px; font-size:16px; border-radius:10px; cursor:pointer; transition:0.3s; display:flex; align-items:center; gap:8px; justify-content:center;}
button:hover { background:#4caf70; }
.course-btn { width:100%; justify-content:flex-start; padding:12px; font-size:16px; margin:6px 0; background:#a8e6cf; color:#2c3e50; }
.course-btn:hover { background:#8bd6b5; }
form { display:flex; flex-direction:column; gap:18px; }
input, select, textarea { padding:12px; border:1px solid #ccc; border-radius:8px; font-size:14px; width:100%; }
label { font-weight:600; margin-bottom:5px; display:flex; align-items:center; gap:6px; }
.hidden { display:none; color:#e74c3c; font-size:13px; }
.icon-red { stroke:#e74c3c; stroke-width:2px; }
.icon-green { stroke:#27ae60; stroke-width:2px; }
.icon-blue { stroke:#3498db; stroke-width:2px; }
.icon-orange { stroke:#e67e22; stroke-width:2px; }
.icon-purple { stroke:#9b59b6; stroke-width:2px; }
#cursoSelecionado { margin-top:10px; font-weight:600; font-size:16px; color:#fff; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

/* Botão Admin fixo */
.admin-btn { position:fixed; top:10px; right:10px; background:#3498db; font-size:14px; padding:8px 12px; border-radius:8px; z-index:1000; }
.admin-btn:hover { background:#2c80b3; }

/* Modal Admin */
#adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; justify-content:center; align-items:center; }
#adminContent { background:#fff; padding:20px; width:400px; border-radius:16px; max-height:90%; overflow-y:auto; }
#adminContent h2{ margin-top:0; }
#adminContent label{ display:block; margin-top:10px; }
#adminContent input{ width:100%; }
#listaCursosAdmin li { margin-bottom:6px; }
#listaCursosAdmin button { background:#e74c3c; font-size:12px; padding:4px 8px; margin-left:6px; }

/* RESPONSIVIDADE */
@media (max-width: 768px) {
  header { padding: 20px 10px; }
  h1 { font-size: 22px; }
  h2 { font-size: 14px; }
  .container { padding: 10px; margin: 10px auto; }
  .card { padding: 15px; }
  button { font-size: 14px; padding: 10px 14px; }
  .course-btn { font-size: 14px; padding: 10px; }
  input, select, textarea { font-size: 14px; padding: 10px; }
  #adminContent { width: 90%; max-width: 350px; }
}

@media (max-width: 480px) {
  h1 { font-size: 20px; }
  h2 { font-size: 12px; }
  button { width: 100%; font-size: 14px; padding: 10px; }
  .course-btn { font-size: 13px; }
  input, select, textarea { font-size: 13px; }
  #cursoSelecionado { flex-direction: column; align-items: flex-start; font-size: 14px; }
}
</style>
</head>
<body>

<button class="admin-btn" onclick="abrirLoginAdmin()">Administrador</button>

<!-- Página 1 -->
<div id="pagina1">
<header>
<h1>Sistema de Matrícula - ONG Moradia e Cidadania</h1>
<h2>Bem-vindo ao nosso sistema de matrícula online</h2>
</header>
<div class="container">
  <div class="card" id="listaCursos">
    <h3><i data-lucide="book-open" class="icon-red"></i> Selecione o curso desejado</h3>
  </div>
  <div class="card">
    <h3><i data-lucide="users" class="icon-green"></i> Sobre Nossa ONG</h3>
    <p>A ONG Moradia e Cidadania atua há mais de 15 anos promovendo inclusão social e capacitação profissional para comunidades de baixa renda. Nossos cursos gratuitos visam proporcionar mais oportunidades e melhor qualidade de vida.</p>
  </div>
</div>
</div>

<!-- Página 2 -->
<div id="pagina2" class="hidden">
<header>
<h1><i data-lucide="clipboard-list" class="icon-purple"></i> Formulário de Matrícula</h1>
<div id="cursoSelecionado"></div>
</header>
<div class="container">
<div class="card">
<form id="formMatricula">
  <div><label for="nome"><i data-lucide="user" class="icon-red"></i> Nome completo</label>
      <input type="text" id="nome" required><span class="hidden" id="nomeError">Campo obrigatório</span></div>
  <div><label for="cpf"><i data-lucide="id-card" class="icon-orange"></i> CPF</label>
      <input type="text" id="cpf" placeholder="000.000.000-00" required maxlength="14"><span class="hidden" id="cpfError">Campo obrigatório</span></div>
  <div><label for="nascimento"><i data-lucide="calendar" class="icon-blue"></i> Data de nascimento</label>
      <input type="date" id="nascimento" required><span class="hidden" id="nascimentoError">Campo obrigatório</span></div>
  <div><label for="sexo"><i data-lucide="user-check" class="icon-green"></i> Sexo</label>
      <select id="sexo" required><option value="">Selecione...</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Outro">Outro</option></select><span class="hidden" id="sexoError">Campo obrigatório</span></div>
  <div><label for="orientacao"><i data-lucide="heart" class="icon-purple"></i> Orientação Sexual</label>
      <input type="text" id="orientacao" required><span class="hidden" id="orientacaoError">Campo obrigatório</span></div>
  <div><label for="email"><i data-lucide="mail" class="icon-purple"></i> E-mail</label>
      <input type="email" id="email" required><span class="hidden" id="emailError">Campo obrigatório</span></div>
  <div><label for="telefone"><i data-lucide="phone" class="icon-green"></i> Telefone</label>
      <input type="tel" id="telefone" placeholder="(00) 00000-0000" required><span class="hidden" id="telefoneError">Campo obrigatório</span></div>
  <div><label for="cep"><i data-lucide="map-pin" class="icon-red"></i> CEP</label>
      <input type="text" id="cep" placeholder="00000-000" onblur="buscarCEP()" required><span class="hidden" id="cepError">Campo obrigatório</span></div>
  <div><label for="endereco"><i data-lucide="home" class="icon-blue"></i> Endereço</label>
      <input type="text" id="endereco" placeholder="Rua, bairro, cidade" readonly required><span class="hidden" id="enderecoError">Campo obrigatório</span></div>
  <div><label for="numero"><i data-lucide="hash" class="icon-orange"></i> Número</label>
      <input type="text" id="numero" placeholder="Número da casa/apto" required><span class="hidden" id="numeroError">Campo obrigatório</span></div>
  <div><label for="curso"><i data-lucide="book" class="icon-green"></i> Curso desejado</label>
      <input type="text" id="curso" readonly required><span class="hidden" id="cursoError">Campo obrigatório</span></div>
  <div><label for="periodo"><i data-lucide="clock" class="icon-orange"></i> Período do curso</label>
      <input type="text" id="periodo" readonly required></div>
  <div><label for="origem"><i data-lucide="message-circle" class="icon-purple"></i> Como você ficou sabendo do curso?</label>
      <input type="text" id="origem" required><span class="hidden" id="origemError">Campo obrigatório</span></div>
  <button type="submit"><i data-lucide="send" class="icon-orange"></i> Enviar Matrícula</button>
</form>
</div>
</div>
</div>

<!-- Modal Admin -->
<div id="adminModal">
  <div id="adminContent">
    <h2>Painel Administrativo</h2>
    <h3>Login do Administrador</h3>
    <label>Login atual: <span id="adminLoginDisplay">admin</span></label>
    <label>Senha atual: <span id="adminSenhaDisplay">admin</span></label>
    <input type="text" id="adminLoginInput" placeholder="Novo login">
    <input type="text" id="adminSenhaInput" placeholder="Nova senha">
    <button onclick="atualizarLoginSenha()">Atualizar Login/Senha</button>
    <hr>
    <h3>Cursos</h3>
    <ul id="listaCursosAdmin"></ul>
    <input type="text" id="novoCursoNome" placeholder="Nome do curso">
    <input type="text" id="novoCursoPeriodo" placeholder="Período do curso">
    <select id="novoCursoTipo">
      <option value="ingles">Inglês</option>
      <option value="espanhol">Espanhol</option>
      <option value="informatica">Informática</option>
    </select>
    <button onclick="adicionarCurso()">Adicionar Curso</button>
    <hr>
    <button onclick="fecharAdmin()">Fechar Painel</button>
  </div>
</div>

<script>
// Admin
let adminLogin = "admin";
let adminSenha = "admin";

let cursos = [
  {nome:"Inglês", periodo:"Manhã", tipo:"ingles", bandeira:"https://upload.wikimedia.org/wikipedia/en/a/ae/Flag_of_the_United_Kingdom.svg"},
  {nome:"Espanhol", periodo:"Tarde", tipo:"espanhol", bandeira:"https://upload.wikimedia.org/wikipedia/commons/9/9a/Flag_of_Spain.svg"},
  {nome:"Informática", periodo:"Noite", tipo:"informatica", bandeira:"monitor"}
];

// Funções Página inicial
function gerarCursos() {
  const div = document.getElementById("listaCursos");
  div.innerHTML = '<h3><i data-lucide="book-open" class="icon-red"></i> Selecione o curso desejado</h3>';
  cursos.forEach((c,idx)=>{
    let btn = document.createElement("button");
    btn.className="course-btn";
    btn.style.gap="10px";
    btn.innerHTML= c.tipo=="informatica" ? '<i data-lucide="monitor" class="icon-blue"></i> '+c.nome : '<img src="'+c.bandeira+'" width="24"> '+c.nome;
    btn.onclick=()=>{ selecionarCurso(c); };
    div.appendChild(btn);
  });
  lucide.createIcons();
}

// Selecionar curso
function selecionarCurso(curso){
  document.getElementById("cursoSelecionado").innerHTML = 'Curso selecionado: '+(curso.tipo=="informatica"?'<i data-lucide="monitor" class="icon-blue"></i>':'<img src="'+curso.bandeira+'" width="24">')+' '+curso.nome+' ('+curso.periodo+')';
  document.getElementById("curso").value = curso.nome;
  document.getElementById("periodo").value = curso.periodo;
  mostrarPagina2();
  lucide.createIcons();
}

function mostrarPagina2(){
  document.getElementById("pagina1").classList.add("hidden");
  document.getElementById("pagina2").classList.remove("hidden");
}

// Formatar CPF
const cpfInput = document.getElementById("cpf");
cpfInput.addEventListener("input", function() {
  let value = cpfInput.value.replace(/\D/g, "");
  if (value.length > 11) value = value.slice(0,11);
  value = value.replace(/(\d{3})(\d)/, "$1.$2");
  value = value.replace(/(\d{3})(\d)/, "$1.$2");
  value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
  cpfInput.value = value;
});

// CEP
async function buscarCEP(){
  const cep = document.getElementById("cep").value.replace(/\D/g,"");
  if(cep.length===8){
    try{
      const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const data = await response.json();
      if(data.erro){ alert("CEP não encontrado!"); document.getElementById("endereco").value=""; return; }
      document.getElementById("endereco").value = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
    }catch(e){ alert("Erro ao buscar CEP."); }
  }
}

  document.getElementById("formMatricula").addEventListener("submit", async function(e){
    e.preventDefault();
    let campos = ["nome","cpf","nascimento","email","telefone","endereco","numero","origem"]; // Campos da tabela Aluno + CEP/Número (precisa combinar no backend)
    let valido=true;
    let dadosAluno = {};

    campos.forEach(campoId=>{
      let input=document.getElementById(campoId);
      let error=document.getElementById(campoId+"Error");
      if(input && !input.value.trim()){
        if(error) error.classList.remove("hidden");
        valido=false;
      } 
      else {
        if(error) error.classList.add("hidden");
        // Mapeia os IDs do HTML para os nomes das colunas no BD (conforme model/Aluno.js)
        let nomeCampoBD = campoId.charAt(0).toUpperCase() + campoId.slice(1); // Ex: nome -> Nome
        if (nomeCampoBD === "Nascimento") nomeCampoBD = "Data_Nascimento";
        if (nomeCampoBD === "Origem") nomeCampoBD = "Conheceu_Como";
        // Ignora campos que não vão direto para a tabela Aluno (como curso, periodo)
        // O endereço completo precisa ser montado (combinando endereco e numero)
        if (["Nome", "CPF", "Data_Nascimento", "Email", "Telefone", "Conheceu_Como"].includes(nomeCampoBD)) {
             dadosAluno[nomeCampoBD] = input.value.trim();
        }
      }
    });

// Combina endereço e número (exemplo simples, ajuste conforme necessário)
    const enderecoCompleto = `${document.getElementById("endereco").value.trim()}, ${document.getElementById("numero").value.trim()}`;
    dadosAluno["Endereco"] = enderecoCompleto;

    // Adiciona Renda_Familiar (se tiver o campo no HTML, senão, defina um valor padrão ou omita)
    // Supondo que você adicione um campo <input type="number" id="rendaFamiliar">
    const rendaInput = document.getElementById("rendaFamiliar"); // Crie este input no seu HTML se necessário
    if (rendaInput) {
        dadosAluno["Renda_Familiar"] = parseFloat(rendaInput.value) || null;
    }


    if(valido){
      try {
        // Envia os dados para a API
        const response = await fetch('/api/alunos', { // Use o endpoint da sua API
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dadosAluno),
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert("Matrícula enviada com sucesso! ID: " + result.data.id);
            document.getElementById("formMatricula").addEventListener("submit", async function(e){
              e.preventDefault();
            document.getElementById("pagina2").classList.add("hidden");
            document.getElementById("pagina1").classList.remove("hidden");
            document.getElementById("cursoSelecionado").innerHTML='';
            });
        } else {
            // Exibe mensagem de erro da API ou uma genérica
            alert("Erro ao enviar matrícula: " + (result.message || 'Erro desconhecido'));
            console.error("Erro da API:", result);
        }
      } 
      catch (error) {
          alert("Erro de conexão ao enviar matrícula. Tente novamente.");
          console.error("Erro no fetch:", error);
      }
    } else {
         alert("Por favor, preencha todos os campos obrigatórios.");
    }
  });

// Admin
function abrirLoginAdmin(){
  let login = prompt("Login:");
  let senha = prompt("Senha:");
  if(login===adminLogin && senha===adminSenha){
    document.getElementById("adminModal").style.display="flex";
    atualizarListaCursosAdmin();
  } else alert("Login ou senha incorretos!");
}
function fecharAdmin(){ document.getElementById("adminModal").style.display="none"; }
function atualizarLoginSenha(){
  let l=document.getElementById("adminLoginInput").value.trim();
  let s=document.getElementById("adminSenhaInput").value.trim();
  if(l) adminLogin=l;
  if(s) adminSenha=s;
  document.getElementById("adminLoginDisplay").innerText=adminLogin;
  document.getElementById("adminSenhaDisplay").innerText=adminSenha;
  alert("Login e senha atualizados!");
  document.getElementById("adminLoginInput").value="";
  document.getElementById("adminSenhaInput").value="";
}
function atualizarListaCursosAdmin(){
  const ul=document.getElementById("listaCursosAdmin");
  ul.innerHTML="";
  cursos.forEach((c,idx)=>{
    const li=document.createElement("li");
    li.innerHTML=c.nome+" ("+c.periodo+") <button onclick='removerCurso("+idx+")'>X</button>";
    ul.appendChild(li);
  });
}
function adicionarCurso(){
  const nome=document.getElementById("novoCursoNome").value.trim();
  const periodo=document.getElementById("novoCursoPeriodo").value.trim();
  const tipo=document.getElementById("novoCursoTipo").value;
  if(nome && periodo){
    let bandeira="";
    if(tipo=="ingles") bandeira="https://upload.wikimedia.org/wikipedia/en/a/ae/Flag_of_the_United_Kingdom.svg";
    else if(tipo=="espanhol") bandeira="https://upload.wikimedia.org/wikipedia/commons/9/9a/Flag_of_Spain.svg";
    else if(tipo=="informatica") bandeira="monitor";
    cursos.push({nome, periodo, tipo, bandeira});
    atualizarListaCursosAdmin();
    gerarCursos();
    document.getElementById("novoCursoNome").value="";
    document.getElementById("novoCursoPeriodo").value="";
  } else alert("Preencha todos os campos do curso!");
}
function removerCurso(idx){
  cursos.splice(idx,1);
  atualizarListaCursosAdmin();
  gerarCursos();
}

gerarCursos();
lucide.createIcons();
</script>

</body>
</html>
