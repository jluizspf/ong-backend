const express = require('express');
const cors = require('cors');
const path = require('path'); // Adicionado para a rota de health antiga, se necessÃ¡rio
const { initializeDatabase, testConnection } = require('./config/database-sqlite');
const { handleError } = require('./routes/utils');

// ImportaÃ§Ã£o das Rotas
const alunosRoutes = require('./routes/alunos');
const professoresRoutes = require('./routes/professores');
const cursosRoutes = require('./routes/cursos');
const colaboradoresRoutes = require('./routes/colaboradores');

// ConfiguraÃ§Ã£o do App
const app = express();
const PORT = process.env.PORT || 3000;
const NODE_ENV = process.env.NODE_ENV || 'development';

// Middlewares
app.use(cors()); // Habilita CORS para todas as origens
app.use(express.json()); // Middleware para parsear JSON
app.use(express.urlencoded({ extended: true })); // Middleware para parsear form-data

// --- ROTAS PRINCIPAIS ---

// Rota de "Bem-vindo"
app.get('/', (req, res) => {
    res.json({
        message: "API da ONG - Sistema de GestÃ£o Educacional",
        version: "1.0.0", // Do package.json
        status: "online",
        environment: NODE_ENV,
        timestamp: new Date().toISOString()
    });
});

// Rota de saÃºde da API
app.get('/health', async (req, res) => {
    try {
        const dbStatus = await testConnection();
        res.json({
            status: 'ok',
            database: dbStatus ? 'connected' : 'disconnected',
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({
            status: 'error',
            message: 'Erro ao verificar saÃºde da API',
            error: error.message
        });
    }
});

// --- ROTAS DA API ---
app.use('/api/alunos', alunosRoutes);
app.use('/api/professores', professoresRoutes);
app.use('/api/cursos', cursosRoutes);
app.use('/api/colaboradores', colaboradoresRoutes);

// Middleware para rotas nÃ£o encontradas (404)
app.use((req, res, next) => {
    res.status(404).json({ erro: 'Endpoint nÃ£o encontrado', rota: req.originalUrl });
});

// Middleware genÃ©rico de tratamento de erros (fallback)
app.use((err, req, res, next) => {
    console.error("Erro nÃ£o tratado:", err.stack);
    handleError(res, err, 'Erro interno do servidor');
});

// InicializaÃ§Ã£o do Servidor
const startServer = async () => {
    try {
        await initializeDatabase(); // Inicializa o DB (cria tabelas se nÃ£o existirem)
        app.listen(PORT, () => {
            console.log(`ğŸš€ Servidor rodando na porta ${PORT}`);
            console.log(`ğŸ“Š Ambiente: ${NODE_ENV}`);
            console.log(`âœ… ConexÃ£o com banco de dados estabelecida!`);
            console.log(`ğŸŒ API disponÃ­vel em: http://localhost:${PORT}`);
            console.log(`ğŸ“‹ DocumentaÃ§Ã£o (Health): http://localhost:${PORT}/health`);
        });
    } catch (error) {
        console.error("âŒ Falha ao inicializar o servidor:", error);
        process.exit(1); // Sai se nÃ£o conseguir ligar o DB
    }
};

// Inicia o processo
startServer();